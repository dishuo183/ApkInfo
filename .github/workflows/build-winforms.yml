name: Build WinForms APK Analyzer

on:
  push:
    branches: [ main, master ]
    paths:
      - '**'
      - '.github/workflows/build-winforms.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置 MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: 设置 NuGet
      uses: nuget/setup-nuget@v2
    
    - name: 检查资源文件
      run: |
        if (-not (Test-Path "bin/aapt2.exe")) { 
          Write-Error "bin/aapt2.exe not found!" 
          exit 1
        }
        if (-not (Test-Path "bin/android.png")) { 
          Write-Error "bin/android.png not found!" 
          exit 1
        }
        Write-Host "Resource files check passed"
      shell: powershell
    
    - name: 复制资源文件到项目根目录
      run: |
        Copy-Item -Path "bin/aapt2.exe" -Destination "aapt2.exe" -Force
        New-Item -ItemType Directory -Path "res" -Force
        Copy-Item -Path "bin/android.png" -Destination "res/android.png" -Force
      shell: powershell
    
    - name: 转换 PNG 为 ICO
      run: |
        Add-Type -AssemblyName System.Drawing
        $png = [System.Drawing.Image]::FromFile("$PWD\bin\android.png")
        $icon = [System.Drawing.Icon]::FromHandle(([System.Drawing.Bitmap]$png).GetHicon())
        $stream = [System.IO.File]::Create("$PWD\icon.ico")
        $icon.Save($stream)
        $stream.Close()
        $png.Dispose()
        Write-Host "Icon created successfully"
      shell: powershell
    
    - name: 还原 NuGet 包
      run: nuget restore ApkAnalyzer.csproj -PackagesDirectory packages
    
    - name: 编译项目
      run: msbuild ApkAnalyzer.csproj /p:Configuration=Release /p:Platform="Any CPU" /p:OutputPath=bin/Release/
    
    - name: 列出编译输出文件
      run: |
        Write-Host "Build output files:"
        Get-ChildItem -Path "bin/Release/" | Select-Object Name, Length
      shell: powershell
    
    - name: 查找并重命名 exe 文件
      run: |
        $exeFiles = Get-ChildItem -Path "bin/Release/" -Filter "*.exe"
        Write-Host "Found $($exeFiles.Count) exe files:"
        foreach ($file in $exeFiles) {
          Write-Host "  - $($file.Name) ($($file.Length) bytes)"
        }
        
        # 查找主程序（不是 aapt2.exe）
        $mainExe = $exeFiles | Where-Object { $_.Name -ne "aapt2.exe" } | Select-Object -First 1
        
        if ($mainExe) {
          Copy-Item -Path $mainExe.FullName -Destination "ApkAnalyzer.exe" -Force
          Write-Host "Main program found: $($mainExe.Name)"
          Write-Host "Renamed to: ApkAnalyzer.exe"
        } else {
          Write-Error "Main program exe not found!"
          exit 1
        }
      shell: powershell
    
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: APK-Analyzer-WinForms
        path: ApkAnalyzer.exe
        retention-days: 30
