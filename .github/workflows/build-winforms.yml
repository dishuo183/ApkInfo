name: Build WinForms APK Analyzer

on:
  push:
    branches: [ main, master ]
    paths:
      - '**'
      - '.github/workflows/build-winforms.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置 MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: 设置 NuGet
      uses: nuget/setup-nuget@v2
    
    - name: 检查资源文件
      run: |
        if (-not (Test-Path "aapt2.exe")) { 
          Write-Error "aapt2.exe not found!" 
          exit 1
        }
        if (-not (Test-Path "res/android.png")) { 
          Write-Error "res/android.png not found!" 
          exit 1
        }
        Write-Host "Resource files check passed"
      shell: powershell
    
    - name: 还原 NuGet 包
      run: nuget restore ApkAnalyzer.csproj -PackagesDirectory packages
    
    - name: 编译项目
      run: msbuild ApkAnalyzer.csproj /p:Configuration=Release /p:Platform="Any CPU" /p:OutputPath=bin/Release/
    
    - name: 创建发布目录
      run: |
        New-Item -ItemType Directory -Path "release" -Force
        Copy-Item -Path "bin/Release/APK分析工具.exe" -Destination "release/" -Force
        Copy-Item -Path "bin/Release/aapt2.exe" -Destination "release/" -Force
        Copy-Item -Path "bin/Release/res" -Destination "release/" -Recurse -Force
      shell: powershell
    
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: APK分析工具-WinForms
        path: release/
        retention-days: 30
    
    - name: 创建 Release（仅在推送标签时）
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: release/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
